;(function(){
  function qs(s){return document.querySelector(s)}
  function qsa(s){return Array.prototype.slice.call(document.querySelectorAll(s))}
  function on(el, ev, fn){el.addEventListener(ev, fn)}
  function append(parent, el){parent.appendChild(el)}
  function makeRow(cls){var r=document.createElement('div'); r.className='row '+cls; return r}
  function makeBubble(txt){var b=document.createElement('div'); b.className='bubble'; b.textContent=txt; return b}
  function makeMeta(txt){var m=document.createElement('div'); m.className='meta'; m.textContent=txt; return m}
  function pushSystem(t){var el=document.createElement('div'); el.className='system'; el.textContent=t; append(qs('#messages'), el); scrollBottom()}
  function pushMsg(nick, txt, mine){var row=makeRow(mine?'me':'other'); var bubble=makeBubble(txt); var meta=makeMeta(nick); append(row, meta); append(row, bubble); append(qs('#messages'), row); scrollBottom()}
  function pushBot(txt){var row=makeRow('bot'); var bubble=makeBubble(txt); append(row, bubble); append(qs('#messages'), row); scrollBottom()}
  function pushBotStreaming(){var row=makeRow('bot'); var bubble=makeBubble(''); append(row, bubble); append(qs('#messages'), row); scrollBottom(); return bubble}
  function avatarColor(n){var colors=['#f59e0b','#ef4444','#3b82f6','#10b981','#8b5cf6','#ec4899','#14b8a6','#84cc16']; var s=0; for(var i=0;i<(n||'').length;i++){s+=n.charCodeAt(i)||0} return colors[s%colors.length]}
  function makeAvatar(n){var a=document.createElement('div'); a.className='avatar'; a.textContent=(n&&n[0])?n[0]:'?'; a.style.background=avatarColor(n||'?'); return a}
  function renderUsers(list){var box=qs('#userList'); if(!box){return} box.innerHTML=''; (list||[]).forEach(function(u){var nick=typeof u==='string'?u:(u&&u.nick)||''; var online=typeof u==='object'?!!u.online:true; var item=document.createElement('div'); item.className='user-item'; var av=makeAvatar(nick); var name=document.createElement('div'); name.className='user-name'; name.textContent=nick; var pres=document.createElement('div'); pres.className='presence '+(online?'on':'off'); append(item,av); append(item,name); append(item,pres); append(box,item)})}
  function pushWeather(nick, city, days, mine){var row=makeRow(mine?'me':'other'); var meta=makeMeta(nick); var bubble=document.createElement('div'); bubble.className='bubble'; var card=document.createElement('div'); card.className='weather-card'; var head=document.createElement('div'); head.className='weather-header'; head.textContent=city||''; var list=document.createElement('div'); list.className='weather-list'; (days||[]).slice(0,6).forEach(function(d){var item=document.createElement('div'); item.className='weather-item'; var dt=document.createElement('div'); dt.className='w-date'; dt.textContent=d.date||''; var tp=document.createElement('div'); tp.className='w-temp'; tp.textContent=d.temperature||''; var we=document.createElement('div'); we.className='w-weather'; we.textContent=d.weather||''; var wi=document.createElement('div'); wi.className='w-wind'; wi.textContent=d.wind||''; var aq=document.createElement('div'); aq.className='w-aq'; aq.textContent=d.air_quality||''; append(item,dt); append(item,tp); append(item,we); append(item,wi); append(item,aq); append(list,item)}); append(card,head); append(card,list); bubble.appendChild(card); append(row, meta); append(row, bubble); append(qs('#messages'), row); scrollBottom()}
  function pushNews(nick, title, hot, url, mine){var row=makeRow(mine?'me':'other'); var meta=makeMeta(nick); var bubble=document.createElement('div'); bubble.className='bubble'; var card=document.createElement('div'); card.className='news-card'; var t=document.createElement('a'); t.className='news-title'; t.textContent=title||''; if(url){t.href=url; t.target='_blank'; t.rel='noopener noreferrer'} var h=document.createElement('div'); h.className='news-hot'; h.textContent=hot||''; append(card,t); append(card,h); bubble.appendChild(card); append(row, meta); append(row, bubble); append(qs('#messages'), row); scrollBottom()}
  function pushMusic(nick, name, singer, image, url, mine){var row=makeRow(mine?'me':'other'); var meta=makeMeta(nick); var bubble=document.createElement('div'); bubble.className='bubble'; var card=document.createElement('div'); card.className='music-card'; var cover=document.createElement('img'); cover.className='music-cover'; cover.src=image||''; var info=document.createElement('div'); info.className='music-info'; var title=document.createElement('div'); title.className='music-title'; title.textContent=name||''; var by=document.createElement('div'); by.className='music-singer'; by.textContent=singer||''; var player=document.createElement('audio'); player.className='music-player'; player.controls=true; player.preload='metadata'; player.src=url; append(info,title); append(info,by); append(card,cover); append(card,info); append(card,player); bubble.appendChild(card); append(row, meta); append(row, bubble); append(qs('#messages'), row); scrollBottom()}
  function scrollBottom(){var m=qs('#messages'); m.scrollTop=m.scrollHeight}
  function getNick(){return sessionStorage.getItem('nick')||''}
  function getServer(){return sessionStorage.getItem('server')||''}
  function ensureLogin(){var n=getNick(); var s=getServer(); if(!n||!s){location.href='/login'} return {nick:n, server:s}}
  var MOVIE_PARSE='https://jx.m3u8.tv/jiexi/?url='
  function parseMovie(text){var m=text.match(/@ç”µå½±\s*\[(.+?)\]/); if(!m){return null} var url=m[1].trim(); url=url.replace(/^`+|`+$/g,'').replace(/^"+|"+$/g,'').replace(/^'+|'+$/g,''); if(url.endsWith(']')){url=url.slice(0,-1)} if(!/^https?:/i.test(url)){return null} return url}
  function pushMovie(nick, url, mine){var row=makeRow(mine?'me':'other'); var meta=makeMeta(nick); var bubble=document.createElement('div'); bubble.className='bubble'; var iframe=document.createElement('iframe'); iframe.width=400; iframe.height=400; iframe.src=MOVIE_PARSE+encodeURIComponent(url); iframe.setAttribute('frameborder','0'); iframe.setAttribute('allowfullscreen','true'); bubble.appendChild(iframe); append(row, meta); append(row, bubble); append(qs('#messages'), row); scrollBottom()}
  function connect(){var cfg=ensureLogin(); var ws=new WebSocket(cfg.server); ws.onopen=function(){ws.send(JSON.stringify({type:'join', nick:cfg.nick}))}; ws.onmessage=function(e){try{var data=JSON.parse(e.data)}catch(err){return} if(data.type==='system'){pushSystem(data.text)} else if(data.type==='users'){renderUsers(data.list)} else if(data.type==='chat'){var mine=data.nick===cfg.nick; pushMsg(data.nick, data.text, mine); var u=parseMovie(data.text); if(u){pushMovie(data.nick,u,mine)}} else if(data.type==='music'){var mine2=data.nick===cfg.nick; pushMusic(data.nick, data.name, data.singer, data.image, data.url, mine2)} else if(data.type==='weather'){var mine3=data.nick===cfg.nick; pushWeather(data.nick, data.city, data.days, mine3)} else if(data.type==='news'){var mine4=data.nick===cfg.nick; pushNews(data.nick, data.title, data.hot, data.url, mine4)} else if(data.type==='bot'){pushBot(data.text)}}; ws.onerror=function(){pushSystem('è¿æ¥é”™è¯¯')}; ws.onclose=function(e){pushSystem('è¿æ¥å·²å…³é—­ ('+e.code+' '+(e.reason||'')+')')}; return ws}
  function parseAiErr(js){var m=(js&&(js.body||js.error)||'æœªçŸ¥é”™è¯¯'); try{var o=JSON.parse(m); if(o&&o.message){return o.message}}catch(e){} return m}
  function aiTestRetry(prompt, bubble, left){fetch('/ai/test?q='+encodeURIComponent(prompt)).then(function(r){return r.json()}).then(function(js){if(js&&js.ok){bubble.textContent=js.text}else{var msg=parseAiErr(js); if(String(msg).indexOf('System is really busy')!==-1 && left>0){bubble.textContent='æœåŠ¡ç¹å¿™ï¼Œé‡è¯•ä¸­...'; scrollBottom(); setTimeout(function(){aiTestRetry(prompt, bubble, left-1)}, 1200)}else{bubble.textContent='AIé”™è¯¯: '+msg; scrollBottom()}}}).catch(function(){if(left>0){bubble.textContent='æœåŠ¡ç¹å¿™ï¼Œé‡è¯•ä¸­...'; scrollBottom(); setTimeout(function(){aiTestRetry(prompt, bubble, left-1)}, 1200)}else{bubble.textContent='AIæœåŠ¡é”™è¯¯æˆ–æœªé…ç½®'; scrollBottom()}})}
  function send(ws){var v=qs('#msgInput').value.trim(); if(!v){return} ws.send(JSON.stringify({type:'chat', text:v})); if(v.indexOf('@æˆå°ç†')===0){var prompt=v.replace('@æˆå°ç†','').trim(); var bubble=pushBotStreaming(); var es=new EventSource('/ai/sse?q='+encodeURIComponent(prompt)); es.addEventListener('chunk',function(e){bubble.textContent+=e.data; scrollBottom()}); es.addEventListener('done',function(){es.close()}); es.addEventListener('error',function(){try{es.close()}catch(_){} aiTestRetry(prompt, bubble, 2)})} qs('#msgInput').value=''}
  function buildEmoji(){var panel=qs('#emojiPanel'); var list='ğŸ˜€ ğŸ˜ƒ ğŸ˜„ ğŸ˜ ğŸ˜† ğŸ˜… ğŸ˜‚ ğŸ™‚ ğŸ˜‰ ğŸ˜Š ğŸ˜‡ ğŸ™ƒ ğŸ˜ ğŸ˜˜ ğŸ˜œ ğŸ¤— ğŸ¤” ğŸ¤¨ ğŸ˜ ğŸ˜‘ ğŸ˜¶ ğŸ™„ ğŸ˜ ğŸ˜£ ğŸ˜¥ ğŸ˜® ğŸ¤ ğŸ˜¯ ğŸ˜ª ğŸ˜« ğŸ¥± ğŸ˜´ ğŸ¤’ ğŸ¤• ğŸ¤¢ ğŸ¤® ğŸ¤§ ğŸ¥µ ğŸ¥¶ ğŸ˜µ ğŸ¤¯ ğŸ¤  ğŸ˜ ğŸ¥¸ ğŸ¤“ ğŸ§ ğŸ˜• ğŸ˜Ÿ ğŸ™ â˜¹ï¸ ğŸ˜®â€ğŸ’¨ ğŸ˜¤ ğŸ˜¢ ğŸ˜­ ğŸ˜¦ ğŸ˜§ ğŸ˜¨ ğŸ˜± ğŸ˜° ğŸ˜³ ğŸ¥º ğŸ¤¤ ğŸ¤© ğŸ¥° ğŸ’˜ ğŸ’– ğŸ’— ğŸ’™ ğŸ’š ğŸ’› ğŸ’œ ğŸ§¡ ğŸ¤ ğŸ¤ â¤ï¸'.split(' '); list.forEach(function(e){var i=document.createElement('div'); i.className='emoji-item'; i.textContent=e; on(i,'click',function(){qs('#msgInput').value+=e; qs('#msgInput').focus()}); append(panel,i)})}
  function toggleEmoji(){var p=qs('#emojiPanel'); if(p.classList.contains('hidden')){p.classList.remove('hidden')}else{p.classList.add('hidden')}}
  var ws=connect()
  fetch('/users').then(function(r){return r.json()}).then(function(js){renderUsers(js.list||[])})
  on(qs('#sendBtn'),'click',function(){send(ws)})
  on(qs('#msgInput'),'keydown',function(e){if(e.key==='Enter'){e.preventDefault(); send(ws)}})
  on(qs('#emojiBtn'),'click',function(){toggleEmoji()})
  on(qs('#historyBtn'),'click',function(){alert('å†å²è®°å½•åŠŸèƒ½æ­£åœ¨å»ºè®¾ä¸­')})
  on(qs('#exitBtn'),'click',function(){try{ws.close()}catch(e){} location.href='/login'})
  buildEmoji()
})();
